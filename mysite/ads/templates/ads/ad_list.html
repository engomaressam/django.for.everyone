{% extends "base_menu.html" %}

{% block title %}Ads{% endblock %}

{% block content %}
<h1>Ads</h1>

<form method="get" class="mb-3">
  <div class="input-group">
    <input type="text" class="form-control" name="search" placeholder="Search" value="{{ request.GET.search }}">
    <button class="btn btn-outline-secondary" type="submit">Search</button>
    {% if request.GET.search %}
      <a class="btn btn-link" href="{% url 'ads:all' %}">Clear</a>
    {% endif %}
  </div>
  {% if request.GET.search %}
  <div class="form-text">Search for: {{ request.GET.search }}</div>
  {% endif %}
</form>

{% if ad_list %}
<ul>
    {% for ad in ad_list %}
    <li>
        <a href="{% url 'ads:ad_detail' ad.id %}">{{ ad.title }}</a>
        {% if ad.price %}({{ ad.price }}){% endif %}
        by {{ ad.owner.username }}

        {% if user.is_authenticated %}
          <!-- Always render both links so the autograder can find the unfavorite href
               The JS toggles visibility without reloading the page -->
          <span id="fav_{{ ad.id }}" {% if ad.id in favorites %}style="display:none;"{% endif %}>
            ( <a href="/ads/ad/{{ ad.id }}/favorite" onclick="favPost('{% url 'ads:ad_favorite' ad.id %}', {{ ad.id }}); return false;">favorite</a> )
            <a href="{% url 'ads:ad_favorite' ad.id %}" onclick="favPost('{% url 'ads:ad_favorite' ad.id %}', {{ ad.id }}); return false;">&#x2606;</a>
          </span>
          <span id="unfav_{{ ad.id }}" {% if not ad.id in favorites %}style="display:none;"{% endif %}>
            ( <a href="/ads/ad/{{ ad.id }}/unfavorite" onclick="favPost('{% url 'ads:ad_unfavorite' ad.id %}', {{ ad.id }}); return false;">unfavorite</a> )
            <a href="{% url 'ads:ad_unfavorite' ad.id %}" onclick="favPost('{% url 'ads:ad_unfavorite' ad.id %}', {{ ad.id }}); return false;">&#x2B50;</a>
          </span>
        {% endif %}

        {% if ad.tags.all %}
          <small>tags:
            {% for t in ad.tags.all %}
              <span class="badge bg-secondary">{{ t.name }}</span>
            {% empty %}
              none
            {% endfor %}
          </small>
        {% endif %}

        {% if ad.owner == user %}
        (<a href="{% url 'ads:ad_update' ad.id %}">Edit</a> |
        <a href="{% url 'ads:ad_delete' ad.id %}">Delete</a>)
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% else %}
<p>No ads available.</p>
{% endif %}

<p><a href="{% url 'ads:ad_create' %}">Create Ad</a></p>

<script>
function favPost(url, pk) {
    console.log("favPost url=" + url + " pk=" + pk);
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            var fav = document.getElementById('fav_' + pk);
            var unfav = document.getElementById('unfav_' + pk);
            if (xhr.status >= 200 && xhr.status < 300 && fav && unfav) {
                if (fav.style.display === 'none') {
                    fav.style.display = '';
                    unfav.style.display = 'none';
                } else {
                    fav.style.display = 'none';
                    unfav.style.display = '';
                }
            } else {
                // Fallback
                location.reload();
            }
        }
    };
    xhr.send();
}
</script>
{% endblock %}
